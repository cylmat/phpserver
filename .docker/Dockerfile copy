FROM phpdockerio/php74-fpm:latest
#Ubuntu (debian) 20.04 LTS (Focal Fossa)

# Fix debconf warnings upon build
ARG DEBIAN_FRONTEND=noninteractive

# Install
# be careful of cache
RUN apt-get update && LAST_UPDATE=2020-09-20
RUN apt-get install -y libzip4 libzip-dev lbzip2 zlib1g-dev libicu-dev libxml2-dev
RUN apt-get install -y apt-utils curl gnupg gnupg2 bzip2 sqlite3 vim wget g++ zip

# 7.4
RUN apt-get install -y php7.4-mysql php7.4-redis php7.4-memcached php7.4-pgsql php7.4-sqlite 
RUN apt-get install -y php-curl php-ds php-mbstring php-pear php-psr php-xml php-zip

#PECL
RUN pecl channel-update pecl.php.net && pecl update-channels

# composer
ENV COMPOSER_ALLOW_SUPERUSER=1
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin
RUN mv /usr/local/bin/composer.phar /usr/local/bin/composer && composer --version

###################################
# DATABASES
# DBA BERKELEY
RUN apt-get install -y php7.4-dba

# ODBC inst
#/etc/odbc.ini not needed
#/etc/odbcinst.ini
WORKDIR /tmp
RUN apt-get install -y odbcinst1debian2 libodbc1
RUN wget https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc_8.0.21-1ubuntu20.04_amd64.deb
RUN md5sum mysql-connector-odbc_8.0.21-1ubuntu20.04_amd64.deb
RUN test "$(md5sum mysql-connector-odbc_8.0.21-1ubuntu20.04_amd64.deb)" = "62e280b8d8e5d3531c6de2b57c37b1a5  mysql-connector-odbc_8.0.21-1ubuntu20.04_amd64.deb"
RUN dpkg -i mysql-connector-odbc_8.0.21-1ubuntu20.04_amd64.deb 
RUN apt-get install -y php7.4-odbc

# Php-Redis: https://github.com/phpredis/phpredis/
#RUN echo 'yes' | pecl install redis-5.3.1

##############################
# LUA HAXE NODE
RUN apt-get install -y lua5.1 liblua5.1-0 liblua5.1-0-dev
RUN pecl download lua-2.0.7 && tar xvzf lua-2.0.7.tgz 
WORKDIR /tmp/lua-2.0.7
RUN phpize && ./configure --with-lua-version=5.1 && make && make install

# haxe && v8
RUN apt-get install -y haxe libv8-dev

# node
RUN curl -sL https://deb.nodesource.com/setup_10.x | bash -
RUN apt-get update && apt-get install -y nodejs

###############################
# PROFILING
# Apache bench
RUN apt-get install -y apache2-utils

# coverage
RUN apt-get install -y php7.4-xdebug php7.4-phpdbg
RUN pecl install pcov

# XHPROF (tideways)
WORKDIR /tmp
RUN apt-get install -y graphviz
RUN wget https://github.com/tideways/php-xhprof-extension/archive/master.zip && unzip master.zip && rm master.zip
WORKDIR /tmp/php-xhprof-extension-master 
RUN phpize && ./configure && make && make install
#RUN echo "extension=tideways_xhprof.so" > /etc/php/7.4/fpm/conf.d/xhprof.ini

# clean
#RUN apt-get clean; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /usr/share/doc/*

WORKDIR "/var/www"
